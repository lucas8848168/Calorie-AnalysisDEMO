# 本地模型测试指南

## 📋 诊断结果总结

### ✅ 已确认正常的部分

1. **依赖安装**
   - ✅ `@tensorflow/tfjs@4.22.0` 已安装
   - ✅ `@tensorflow-models/mobilenet@2.1.1` 已安装

2. **代码实现**
   - ✅ `src/services/foodDetector.ts` - 食物检测服务（懒加载）
   - ✅ `src/utils/imageProcessor.ts` - 图片处理工具
   - ✅ `src/components/ImageUploader.tsx` - 已集成 detectFood 调用
   - ✅ 使用动态 import 实现代码分割
   - ✅ 懒加载机制避免首次加载过慢

3. **日志增强**
   - ✅ 已添加详细的控制台日志
   - ✅ 可以追踪模型加载和检测过程

### ⚠️ 需要注意的问题

1. **本地检测是非阻塞的**
   - 本地模型检测不会阻止图片上传到后端
   - 只在 confidence > 0.6 时显示警告
   - 用户仍可继续分析

2. **你看到的错误来自后端**
   - 截图中的"这张图片不是食物图片"来自 **Doubao API 返回**
   - 不是本地 MobileNet 模型的判断
   - 后端判断更准确，但消耗 API token

## 🧪 测试方法

### 方法 1: 独立测试页面（推荐）

1. 启动开发服务器：
```bash
npm run dev
```

2. 在浏览器中打开：
```
http://localhost:5173/test-model.html
```

3. 按照页面提示依次测试：
   - 步骤 1: 加载 TensorFlow.js
   - 步骤 2: 加载 MobileNet 模型
   - 步骤 3: 上传图片测试识别

4. 查看执行日志，确认：
   - ✅ TensorFlow.js 版本和后端
   - ✅ MobileNet 加载时间（首次约 2-5 秒）
   - ✅ 图片识别结果和置信度

### 方法 2: 主应用测试

1. 启动开发服务器：
```bash
npm run dev
```

2. 打开浏览器访问：
```
http://localhost:5173
```

3. 打开浏览器开发者工具（F12）

4. 切换到 Console 标签

5. 上传一张图片

6. 查看控制台日志：
```
🚀 开始加载 TensorFlow.js 和 MobileNet...
📦 TensorFlow.js 导入成功
🎮 TensorFlow.js 后端: webgl
📥 开始下载 MobileNet 模型...
✅ MobileNet 模型加载成功！耗时: 2345ms
🔍 开始本地食物检测...
🔄 加载模型...
✅ 模型已就绪
📸 图片已加载: 1440x1080
🤖 开始 AI 分类...
⚡ 分类完成，耗时: 234ms
✅ 本地检测完成: { isFood: true, confidence: 0.85, ... }
✅ 本地模型判断：是食物
```

### 方法 3: 检查网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 上传图片
4. 查找以下请求：
   - `tfjs` 相关的 JS 文件
   - `mobilenet` 相关的 JS 文件
   - `model.json` 和 `.bin` 文件（模型权重）

## 🔍 预期行为

### 首次上传图片时

1. **模型加载**（首次约 2-5 秒）
   - 下载 TensorFlow.js (~500KB)
   - 下载 MobileNet 模型 (~16MB)
   - 初始化 WebGL 后端

2. **本地检测**（约 200-500ms）
   - 图片预处理
   - MobileNet 分类
   - 食物关键词匹配

3. **后端分析**（30-60 秒）
   - 上传到 Doubao API
   - AI 详细分析
   - 返回营养信息

### 后续上传图片时

- 模型已缓存，无需重新下载
- 本地检测更快（100-300ms）

## 🐛 常见问题

### 1. 模型加载失败

**症状**：控制台显示 "Failed to load MobileNet model"

**可能原因**：
- 网络问题（CDN 访问受限）
- 浏览器不支持 WebGL

**解决方法**：
```bash
# 检查依赖是否正确安装
npm list @tensorflow/tfjs @tensorflow-models/mobilenet

# 重新安装
npm install
```

### 2. 检测不准确

**症状**：食物图片被判断为非食物

**原因**：
- MobileNet 是通用图像分类模型，不是专门的食物识别模型
- 只能识别 ImageNet 1000 类中的食物类别
- 本地检测主要用于**快速过滤明显的非食物图片**

**解决方法**：
- 本地检测只是辅助，最终判断由 Doubao API 完成
- 可以调整 `FOOD_KEYWORDS` 增加更多关键词
- 可以降低 confidence 阈值（当前 0.6）

### 3. 性能问题

**症状**：检测速度慢

**可能原因**：
- 图片尺寸过大
- CPU 模式（WebGL 不可用）

**解决方法**：
- 图片已自动压缩到 1280-1600px
- 检查 TensorFlow.js 后端：`tf.getBackend()`
- 应该是 `webgl`，如果是 `cpu` 则性能较差

## 📊 性能指标

### 正常情况下

- **模型加载**：2-5 秒（首次）
- **本地检测**：100-500ms
- **内存占用**：~50MB（模型）
- **后端**：WebGL（GPU 加速）

### 异常情况

- **模型加载**：>10 秒 → 网络问题
- **本地检测**：>2 秒 → CPU 模式或图片过大
- **内存占用**：>200MB → 可能有内存泄漏

## 🎯 结论

根据代码分析，本地模型功能**已正确实现**：

1. ✅ 依赖已安装
2. ✅ 代码逻辑正确
3. ✅ 懒加载机制完善
4. ✅ 已集成到上传流程
5. ✅ 添加了详细日志

**你截图中的错误来自后端 API**，不是本地模型的问题。

建议：
1. 使用 `test-model.html` 独立测试本地模型
2. 查看浏览器控制台日志确认模型是否加载
3. 如果本地检测正常但后端返回"不是食物"，说明图片确实不符合 Doubao API 的判断标准
