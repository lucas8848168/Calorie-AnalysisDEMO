<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…ç†å­˜å‚¨ç©ºé—´</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .warning {
      background: #fff3cd;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      border-left: 4px solid #ffc107;
    }
    .success {
      background: #d4edda;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      border-left: 4px solid #28a745;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #da190b;
    }
    .stats {
      font-family: monospace;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§¹ æ¸…ç†å­˜å‚¨ç©ºé—´</h1>
    
    <div class="info">
      <strong>ğŸ’¡ æç¤º</strong><br>
      å¦‚æœé‡åˆ° "STORAGE_FULL" é”™è¯¯ï¼Œä½¿ç”¨æ­¤å·¥å…·æ¸…ç†å­˜å‚¨ç©ºé—´ã€‚
    </div>

    <div id="stats" class="stats">
      æ­£åœ¨æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ...
    </div>

    <h3>æ¸…ç†é€‰é¡¹</h3>
    
    <button onclick="clearHistory()">
      ğŸ—‘ï¸ æ¸…ç©ºå†å²è®°å½•
    </button>
    
    <button onclick="clearCache()">
      ğŸ’¾ æ¸…ç©ºç¼“å­˜
    </button>
    
    <button onclick="clearAll()" class="danger">
      âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
    </button>

    <button onclick="checkStorage()">
      ğŸ” é‡æ–°æ£€æŸ¥
    </button>

    <div id="result"></div>

    <div class="warning">
      <strong>âš ï¸ æ³¨æ„</strong><br>
      æ¸…ç©ºæ•°æ®åæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚
    </div>
  </div>

  <script>
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function checkStorage() {
      const stats = document.getElementById('stats');
      
      try {
        // æ£€æŸ¥ LocalStorage
        const historyData = localStorage.getItem('food_analyzer_history');
        const historySize = historyData ? historyData.length : 0;
        const historyCount = historyData ? JSON.parse(historyData).length : 0;
        
        // æ£€æŸ¥æ‰€æœ‰ LocalStorage
        let totalSize = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length;
          }
        }
        
        stats.innerHTML = `
          <strong>ğŸ“Š å­˜å‚¨ä½¿ç”¨æƒ…å†µ</strong><br><br>
          <strong>å†å²è®°å½•ï¼š</strong><br>
          - è®°å½•æ•°ï¼š${historyCount} æ¡<br>
          - å¤§å°ï¼š${formatBytes(historySize)}<br><br>
          <strong>LocalStorage æ€»è®¡ï¼š</strong><br>
          - å¤§å°ï¼š${formatBytes(totalSize)}<br>
          - é™åˆ¶ï¼šçº¦ 5-10 MB<br>
          - ä½¿ç”¨ç‡ï¼š${((totalSize / (5 * 1024 * 1024)) * 100).toFixed(1)}%
        `;
        
        // æ£€æŸ¥ IndexedDB ç¼“å­˜
        checkIndexedDB();
      } catch (error) {
        stats.innerHTML = `<span style="color: red;">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</span>`;
      }
    }

    function checkIndexedDB() {
      // æ£€æŸ¥ç¼“å­˜æ•°æ®åº“
      const cacheRequest = indexedDB.open('FoodAnalyzerCache', 1);
      cacheRequest.onsuccess = () => {
        const db = cacheRequest.result;
        const tx = db.transaction('analysisResults', 'readonly');
        const store = tx.objectStore('analysisResults');
        const countRequest = store.count();
        
        countRequest.onsuccess = () => {
          const stats = document.getElementById('stats');
          stats.innerHTML += `<br><strong>IndexedDB ç¼“å­˜ï¼š</strong><br>- è®°å½•æ•°ï¼š${countRequest.result} æ¡`;
        };
      };

      // æ£€æŸ¥å†å²è®°å½•æ•°æ®åº“
      const historyRequest = indexedDB.open('FoodAnalyzerHistory', 1);
      historyRequest.onsuccess = () => {
        const db = historyRequest.result;
        const tx = db.transaction('historyRecords', 'readonly');
        const store = tx.objectStore('historyRecords');
        const countRequest = store.count();
        
        countRequest.onsuccess = () => {
          const stats = document.getElementById('stats');
          stats.innerHTML += `<br><strong>IndexedDB å†å²è®°å½•ï¼š</strong><br>- è®°å½•æ•°ï¼š${countRequest.result} æ¡`;
        };
      };
    }

    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
        try {
          // æ¸…ç©ºæ—§çš„ LocalStorage å†å²è®°å½•
          localStorage.removeItem('food_analyzer_history');
          // æ¸…ç©ºæ–°çš„ IndexedDB å†å²è®°å½•
          indexedDB.deleteDatabase('FoodAnalyzerHistory');
          showResult('âœ… å†å²è®°å½•å·²æ¸…ç©º', 'success');
          setTimeout(checkStorage, 500);
        } catch (error) {
          showResult('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
        }
      }
    }

    function clearCache() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºç¼“å­˜å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
        try {
          indexedDB.deleteDatabase('FoodAnalyzerCache');
          showResult('âœ… ç¼“å­˜å·²æ¸…ç©º', 'success');
          setTimeout(checkStorage, 500);
        } catch (error) {
          showResult('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
        }
      }
    }

    function clearAll() {
      if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ï¼š\n- å†å²è®°å½•\n- ç¼“å­˜\n- æ‰€æœ‰è®¾ç½®\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        try {
          localStorage.clear();
          indexedDB.deleteDatabase('FoodAnalyzerCache');
          indexedDB.deleteDatabase('FoodAnalyzerHistory');
          showResult('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
          setTimeout(checkStorage, 500);
        } catch (error) {
          showResult('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
        }
      }
    }

    function showResult(message, type) {
      const result = document.getElementById('result');
      result.className = type === 'success' ? 'success' : 'warning';
      result.innerHTML = message;
      result.style.display = 'block';
      
      setTimeout(() => {
        result.style.display = 'none';
      }, 5000);
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
    window.onload = checkStorage;
  </script>
</body>
</html>
