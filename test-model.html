<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°æ¨¡å‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        #preview {
            max-width: 400px;
            margin: 10px 0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æœ¬åœ°æ¨¡å‹åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. TensorFlow.js åŠ è½½æµ‹è¯•</h2>
        <button onclick="testTensorFlow()">æµ‹è¯• TensorFlow.js</button>
        <div id="tf-status"></div>
    </div>

    <div class="test-section">
        <h2>2. MobileNet æ¨¡å‹åŠ è½½æµ‹è¯•</h2>
        <button onclick="testMobileNet()">åŠ è½½ MobileNet æ¨¡å‹</button>
        <div id="mobilenet-status"></div>
    </div>

    <div class="test-section">
        <h2>3. é£Ÿç‰©æ£€æµ‹æµ‹è¯•</h2>
        <input type="file" id="imageInput" accept="image/*">
        <br>
        <img id="preview" style="display:none;">
        <br>
        <button onclick="testFoodDetection()">æ£€æµ‹å›¾ç‰‡</button>
        <div id="detection-status"></div>
    </div>

    <script type="module">
        let tf, mobilenet, model;

        window.testTensorFlow = async function() {
            const statusDiv = document.getElementById('tf-status');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨åŠ è½½ TensorFlow.js...</div>';
            
            try {
                tf = await import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js');
                await tf.ready();
                
                const backend = tf.getBackend();
                const version = tf.version.tfjs;
                
                statusDiv.innerHTML = `
                    <div class="status success">
                        âœ… TensorFlow.js åŠ è½½æˆåŠŸï¼
                        <br>ç‰ˆæœ¬: ${version}
                        <br>åç«¯: ${backend}
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        âŒ TensorFlow.js åŠ è½½å¤±è´¥
                        <br>é”™è¯¯: ${error.message}
                    </div>
                `;
                console.error(error);
            }
        };

        window.testMobileNet = async function() {
            const statusDiv = document.getElementById('mobilenet-status');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨åŠ è½½ MobileNet æ¨¡å‹...</div>';
            
            try {
                if (!tf) {
                    tf = await import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js');
                    await tf.ready();
                }
                
                mobilenet = await import('https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/dist/mobilenet.min.js');
                
                const startTime = Date.now();
                model = await mobilenet.load({
                    version: 2,
                    alpha: 1.0,
                });
                const loadTime = Date.now() - startTime;
                
                statusDiv.innerHTML = `
                    <div class="status success">
                        âœ… MobileNet æ¨¡å‹åŠ è½½æˆåŠŸï¼
                        <br>åŠ è½½æ—¶é—´: ${loadTime}ms
                        <br>æ¨¡å‹ç‰ˆæœ¬: 2
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        âŒ MobileNet æ¨¡å‹åŠ è½½å¤±è´¥
                        <br>é”™è¯¯: ${error.message}
                    </div>
                `;
                console.error(error);
            }
        };

        window.testFoodDetection = async function() {
            const statusDiv = document.getElementById('detection-status');
            const fileInput = document.getElementById('imageInput');
            const preview = document.getElementById('preview');
            
            if (!fileInput.files || !fileInput.files[0]) {
                statusDiv.innerHTML = '<div class="status error">è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æ£€æµ‹...</div>';
            
            try {
                // ç¡®ä¿æ¨¡å‹å·²åŠ è½½
                if (!model) {
                    await window.testMobileNet();
                }
                
                // è¯»å–å›¾ç‰‡
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = async function() {
                        try {
                            const startTime = Date.now();
                            const predictions = await model.classify(img, 5);
                            const detectTime = Date.now() - startTime;
                            
                            // é£Ÿç‰©å…³é”®è¯
                            const foodKeywords = [
                                'food', 'dish', 'meal', 'plate', 'bowl', 'cup',
                                'pizza', 'burger', 'sandwich', 'salad', 'soup',
                                'bread', 'cake', 'cookie', 'fruit', 'vegetable',
                                'meat', 'chicken', 'fish', 'rice', 'noodle'
                            ];
                            
                            let isFood = false;
                            let maxFoodConfidence = 0;
                            
                            predictions.forEach(pred => {
                                const className = pred.className.toLowerCase();
                                const isFoodClass = foodKeywords.some(keyword => 
                                    className.includes(keyword)
                                );
                                
                                if (isFoodClass) {
                                    isFood = true;
                                    maxFoodConfidence = Math.max(maxFoodConfidence, pred.probability);
                                }
                            });
                            
                            const resultHtml = `
                                <div class="status ${isFood ? 'success' : 'error'}">
                                    ${isFood ? 'âœ… æ£€æµ‹åˆ°é£Ÿç‰©' : 'âŒ æœªæ£€æµ‹åˆ°é£Ÿç‰©'}
                                    <br>æ£€æµ‹æ—¶é—´: ${detectTime}ms
                                    <br>é£Ÿç‰©ç½®ä¿¡åº¦: ${(maxFoodConfidence * 100).toFixed(1)}%
                                </div>
                                <pre>${JSON.stringify(predictions, null, 2)}</pre>
                            `;
                            
                            statusDiv.innerHTML = resultHtml;
                        } catch (error) {
                            statusDiv.innerHTML = `
                                <div class="status error">
                                    âŒ æ£€æµ‹å¤±è´¥
                                    <br>é”™è¯¯: ${error.message}
                                </div>
                            `;
                            console.error(error);
                        }
                    };
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        âŒ æ£€æµ‹å¤±è´¥
                        <br>é”™è¯¯: ${error.message}
                    </div>
                `;
                console.error(error);
            }
        };

        // è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', async () => {
            console.log('å¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            await testTensorFlow();
            await testMobileNet();
        });
    </script>
</body>
</html>
