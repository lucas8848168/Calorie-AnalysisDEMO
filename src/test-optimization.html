<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼˜åŒ–æµ‹è¯•é¡µé¢</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .test-section h2 {
      margin-top: 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    .log {
      background: #f5f5f5;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: green; }
    .error { color: red; }
    .warning { color: orange; }
  </style>
</head>
<body>
  <h1>ğŸ§ª å›¾ç‰‡å¤„ç†ä¼˜åŒ–æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>1. æµ‹è¯•å›¾ç‰‡å‹ç¼©</h2>
    <input type="file" id="fileInput" accept="image/*">
    <button onclick="testCompression()">æµ‹è¯•å‹ç¼©</button>
    <div id="compressionLog" class="log"></div>
  </div>
  
  <div class="test-section">
    <h2>2. æµ‹è¯•æœ¬åœ°æ£€æµ‹</h2>
    <button onclick="testDetection()">æµ‹è¯• MobileNet</button>
    <div id="detectionLog" class="log"></div>
  </div>
  
  <div class="test-section">
    <h2>3. æµ‹è¯•ç¼“å­˜</h2>
    <button onclick="testCache()">æµ‹è¯•ç¼“å­˜</button>
    <button onclick="clearCache()">æ¸…ç©ºç¼“å­˜</button>
    <div id="cacheLog" class="log"></div>
  </div>
  
  <div class="test-section">
    <h2>4. æµ‹è¯•å®Œæ•´æµç¨‹</h2>
    <button onclick="testFullFlow()">å®Œæ•´æµ‹è¯•</button>
    <div id="fullFlowLog" class="log"></div>
  </div>

  <script type="module">
    import { processImage } from './utils/imageProcessor.js';
    import { detectFood } from './services/foodDetector.js';
    import { getCachedResult, saveCachedResult, getCacheStats } from './services/cacheService.js';
    
    window.testCompression = async function() {
      const log = document.getElementById('compressionLog');
      log.innerHTML = 'å¼€å§‹æµ‹è¯•...<br>';
      
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        log.innerHTML += '<span class="error">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</span><br>';
        return;
      }
      
      try {
        log.innerHTML += `åŸå§‹æ–‡ä»¶: ${file.name}, ${(file.size / 1024).toFixed(0)}KB<br>`;
        const result = await processImage(file);
        log.innerHTML += `<span class="success">âœ… å‹ç¼©æˆåŠŸ</span><br>`;
        log.innerHTML += `å°ºå¯¸: ${result.dimensions.width}x${result.dimensions.height}<br>`;
        log.innerHTML += `æ ¼å¼: ${result.format.toUpperCase()}<br>`;
        log.innerHTML += `å‹ç¼©å: ${(result.compressedSize / 1024).toFixed(0)}KB<br>`;
        log.innerHTML += `å‹ç¼©ç‡: ${((1 - result.compressedSize / result.originalSize) * 100).toFixed(1)}%<br>`;
      } catch (error) {
        log.innerHTML += `<span class="error">âŒ é”™è¯¯: ${error.message}</span><br>`;
      }
    };
    
    window.testDetection = async function() {
      const log = document.getElementById('detectionLog');
      log.innerHTML = 'åŠ è½½ MobileNet æ¨¡å‹...<br>';
      
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        log.innerHTML += '<span class="error">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</span><br>';
        return;
      }
      
      try {
        const processed = await processImage(file);
        log.innerHTML += 'å¼€å§‹æ£€æµ‹...<br>';
        const result = await detectFood(processed.dataUrl);
        log.innerHTML += `<span class="success">âœ… æ£€æµ‹å®Œæˆ</span><br>`;
        log.innerHTML += `æ˜¯å¦é£Ÿç‰©: ${result.isFood ? 'æ˜¯' : 'å¦'}<br>`;
        log.innerHTML += `ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%<br>`;
        log.innerHTML += `åŸå› : ${result.reason}<br>`;
        log.innerHTML += `Top3:<br>`;
        result.predictions.slice(0, 3).forEach((p, i) => {
          log.innerHTML += `  ${i + 1}. ${p.className} (${(p.probability * 100).toFixed(1)}%)<br>`;
        });
      } catch (error) {
        log.innerHTML += `<span class="error">âŒ é”™è¯¯: ${error.message}</span><br>`;
      }
    };
    
    window.testCache = async function() {
      const log = document.getElementById('cacheLog');
      log.innerHTML = 'æµ‹è¯•ç¼“å­˜...<br>';
      
      try {
        const stats = await getCacheStats();
        log.innerHTML += `<span class="success">âœ… ç¼“å­˜å¯ç”¨</span><br>`;
        log.innerHTML += `ç¼“å­˜æ•°é‡: ${stats.count}<br>`;
      } catch (error) {
        log.innerHTML += `<span class="error">âŒ é”™è¯¯: ${error.message}</span><br>`;
      }
    };
    
    window.clearCache = async function() {
      const log = document.getElementById('cacheLog');
      try {
        indexedDB.deleteDatabase('FoodAnalyzerCache');
        log.innerHTML = '<span class="success">âœ… ç¼“å­˜å·²æ¸…ç©º</span><br>';
      } catch (error) {
        log.innerHTML = `<span class="error">âŒ é”™è¯¯: ${error.message}</span><br>`;
      }
    };
    
    window.testFullFlow = async function() {
      const log = document.getElementById('fullFlowLog');
      log.innerHTML = 'å¼€å§‹å®Œæ•´æµ‹è¯•...<br>';
      
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        log.innerHTML += '<span class="error">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</span><br>';
        return;
      }
      
      try {
        // æ­¥éª¤ 1: å‹ç¼©
        log.innerHTML += 'ğŸ“¸ æ­¥éª¤ 1/4: å›¾ç‰‡å‹ç¼©...<br>';
        const processed = await processImage(file);
        log.innerHTML += `âœ… å‹ç¼©å®Œæˆ: ${(processed.compressedSize / 1024).toFixed(0)}KB<br>`;
        
        // æ­¥éª¤ 2: æ£€æµ‹
        log.innerHTML += 'ğŸ¤– æ­¥éª¤ 2/4: æœ¬åœ°æ£€æµ‹...<br>';
        const detection = await detectFood(processed.dataUrl);
        log.innerHTML += `âœ… æ£€æµ‹å®Œæˆ: ${detection.reason}<br>`;
        
        // æ­¥éª¤ 3: ç¼“å­˜
        log.innerHTML += 'ğŸ’¾ æ­¥éª¤ 3/4: æ£€æŸ¥ç¼“å­˜...<br>';
        const cached = await getCachedResult(processed.dataUrl);
        if (cached) {
          log.innerHTML += '<span class="success">âœ… ç¼“å­˜å‘½ä¸­</span><br>';
        } else {
          log.innerHTML += 'ğŸ“­ ç¼“å­˜æœªå‘½ä¸­<br>';
        }
        
        log.innerHTML += '<span class="success">âœ… æ‰€æœ‰æ­¥éª¤å®Œæˆ</span><br>';
      } catch (error) {
        log.innerHTML += `<span class="error">âŒ é”™è¯¯: ${error.message}</span><br>`;
        console.error(error);
      }
    };
  </script>
</body>
</html>
