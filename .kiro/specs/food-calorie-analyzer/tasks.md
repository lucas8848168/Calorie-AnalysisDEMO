# 实施计划

## 基础功能（P0）

- [x] 1. 初始化项目结构和配置
  - 使用Vite创建React + TypeScript项目
  - 配置Vitest测试框架
  - 安装fast-check属性测试库
  - 配置ESLint和Prettier
  - 创建基础目录结构（components、utils、types、services）
  - _Requirements: 10.2, 10.4_

- [x] 2. 实现核心类型定义
  - 创建TypeScript接口文件（types/index.ts）
  - 定义FoodItem、NutritionInfo、AnalysisResult等数据模型
  - 定义ProcessedImage、ImageMetadata等图片相关类型
  - 定义API请求和响应类型
  - 定义P1增强功能类型（MealRecord、UserGoal、FavoriteFood等）
  - _Requirements: 1.1, 2.2, 3.1, 4.1-4.5, 11.1-14.15_

- [x] 3. 实现图片处理模块
- [x] 3.1 创建图片验证和检测功能
  - 实现文件格式验证函数（validateFileFormat）
  - 实现文件大小检查函数
  - 实现图片分辨率检测函数
  - 实现图片元数据提取
  - _Requirements: 1.1, 1.2, 1.3_

- [ ]* 3.2 编写属性测试 - 文件格式验证
  - **Property 1: 文件格式验证正确性**
  - **Validates: Requirements 1.1**

- [ ]* 3.3 编写属性测试 - 分辨率检测
  - **Property 2: 图片分辨率检测准确性**
  - **Validates: Requirements 1.3**

- [x] 3.4 实现图片压缩功能
  - 使用Canvas API实现图片压缩
  - 实现二分法质量调整算法
  - 处理超过1280px的图片
  - 处理超过2MB的文件
  - 生成Base64编码的压缩图片
  - 支持WebP格式优化
  - _Requirements: 1.4, 1.5, 1.6_

- [ ]* 3.5 编写属性测试 - 高分辨率压缩
  - **Property 3: 高分辨率图片压缩**
  - **Validates: Requirements 1.4**

- [ ]* 3.6 编写属性测试 - 大文件压缩
  - **Property 4: 大文件压缩**
  - **Validates: Requirements 1.5**

- [ ]* 3.7 编写属性测试 - 预览可用性
  - **Property 5: 压缩后预览可用性**
  - **Validates: Requirements 1.6**

- [ ]* 3.8 编写单元测试 - 图片处理边界情况
  - 测试空文件处理
  - 测试损坏图片处理
  - 测试10MB边界情况
  - _Requirements: 1.2, 1.8_

- [x] 4. 实现本地存储管理模块
- [x] 4.1 创建LocalStorage服务
  - 实现saveRecord函数
  - 实现getRecords函数
  - 实现deleteRecord函数
  - 实现clearAll函数
  - 添加错误处理（存储已满、被禁用）
  - _Requirements: 6.1, 6.2, 6.5_

- [ ]* 4.2 编写属性测试 - 存储往返一致性
  - **Property 13: 历史记录存储往返一致性**
  - **Validates: Requirements 6.1**

- [ ]* 4.3 编写属性测试 - 删除一致性
  - **Property 15: 历史记录删除一致性**
  - **Validates: Requirements 6.5**

- [ ]* 4.4 编写单元测试 - 存储错误处理
  - 测试LocalStorage已满场景
  - 测试LocalStorage被禁用场景
  - _Requirements: 6.1_

- [x] 5. 实现数据解析和计算工具
- [x] 5.1 创建API响应解析函数
  - 实现parseAnalysisResponse函数
  - 提取食物名称和营养数据
  - 处理空结果和错误响应
  - 验证数据完整性
  - _Requirements: 2.2, 2.3, 2.4, 4.1-4.5_

- [ ]* 5.2 编写属性测试 - API响应解析
  - **Property 6: API响应解析完整性**
  - **Validates: Requirements 2.2**

- [ ]* 5.3 编写属性测试 - 多食物列表
  - **Property 7: 多食物列表完整性**
  - **Validates: Requirements 2.3**

- [ ]* 5.4 编写属性测试 - 营养数据完整性
  - **Property 11: 营养成分数据完整性**
  - **Property 12: 营养成分结构化格式**
  - **Validates: Requirements 4.1, 4.2, 4.3, 4.4, 4.5**

- [x] 5.5 实现卡路里计算函数
  - 实现calculateTotalCalories函数
  - 验证单个食物卡路里数据
  - 计算多食物总和
  - _Requirements: 3.1, 3.2, 3.3_

- [ ]* 5.6 编写属性测试 - 卡路里计算
  - **Property 8: 卡路里数据存在性**
  - **Property 10: 卡路里总和正确性**
  - **Validates: Requirements 3.1, 3.3**

- [ ]* 5.7 编写属性测试 - 卡路里单位
  - **Property 9: 卡路里单位一致性**
  - **Validates: Requirements 3.2**

- [ ]* 5.8 编写单元测试 - 边界情况
  - 测试空食物列表
  - 测试无卡路里数据的处理
  - 测试范围值显示
  - _Requirements: 2.4, 3.4_

- [x] 6. 实现Cloudflare Workers后端API
- [x] 6.1 创建Workers项目结构
  - 初始化Cloudflare Workers项目
  - 配置wrangler.toml
  - 设置环境变量配置
  - 创建API路由处理器
  - _Requirements: 7.1, 7.2, 10.3_

- [x] 6.2 实现API密钥管理和验证
  - 从环境变量读取API密钥
  - 实现启动时密钥验证
  - 添加密钥格式检查
  - 实现错误日志记录
  - _Requirements: 7.1, 7.2, 7.3, 7.5_

- [x] 6.3 实现方舟豆包API集成
  - 创建API客户端服务
  - 实现图片分析请求
  - 构建Prompt模板
  - 处理API响应
  - 实现指数退避重试逻辑
  - _Requirements: 2.1, 8.1, 8.2_

- [ ]* 6.4 编写属性测试 - 图片压缩验证
  - **Property 16: API请求图片压缩验证**
  - **Validates: Requirements 8.2**

- [x] 6.5 实现请求验证和错误处理
  - 验证请求格式和大小
  - 实现速率限制
  - 处理API调用失败
  - 实现临时文件清理
  - 返回统一错误格式
  - _Requirements: 2.5, 8.3, 8.4, 8.5_

- [ ]* 6.6 编写属性测试 - 临时文件清理
  - **Property 17: 临时文件清理**
  - **Validates: Requirements 8.3**

- [ ]* 6.7 编写单元测试 - API错误处理
  - 测试API密钥缺失场景
  - 测试API调用超时
  - 测试限流处理
  - 测试错误响应格式
  - _Requirements: 2.5, 7.3, 8.4_

- [x] 7. 实现前端UI组件
- [x] 7.1 创建ImageUploader组件
  - 实现文件选择界面
  - 集成图片验证和压缩逻辑
  - 显示图片预览
  - 显示处理进度
  - 实现错误提示
  - _Requirements: 1.1-1.8, 5.1, 5.2_

- [x] 7.2 创建LoadingIndicator组件
  - 实现加载动画
  - 显示处理状态消息
  - 在3秒内响应
  - _Requirements: 5.1, 5.2_

- [x] 7.3 创建AnalysisDisplay组件
  - 显示食物识别结果
  - 显示卡路里信息（带单位）
  - 显示营养成分表格
  - 显示置信度和说明
  - 添加"重新分析"和"上传新图片"按钮
  - 处理空结果和错误状态
  - _Requirements: 2.2, 2.3, 2.4, 3.1-3.5, 4.1-4.5, 5.3, 5.4_

- [ ]* 7.4 编写属性测试 - 结果过滤
  - **Property 18: 结果过滤正确性**
  - **Validates: Requirements 9.4**

- [x] 7.5 创建HistoryList组件
  - 显示历史记录列表
  - 显示缩略图、食物名称、卡路里、时间
  - 实现点击查看详情
  - 实现删除功能
  - 处理空历史状态
  - _Requirements: 6.2, 6.3, 6.4, 6.5_

- [ ]* 7.6 编写属性测试 - 历史记录显示
  - **Property 14: 历史记录显示完整性**
  - **Validates: Requirements 6.3**

- [x] 7.6 实现响应式布局
  - 使用CSS媒体查询
  - 优化移动端触摸交互
  - 测试不同屏幕尺寸
  - _Requirements: 5.5_

- [ ]* 7.7 编写单元测试 - UI组件
  - 测试组件渲染
  - 测试用户交互
  - 测试错误状态显示
  - _Requirements: 5.4, 6.4_

- [x] 8. 集成前后端并实现主应用
- [x] 8.1 创建API服务客户端
  - 实现fetch封装
  - 处理请求和响应
  - 实现超时控制
  - 处理网络错误
  - _Requirements: 2.1, 2.5, 8.1, 8.5_

- [x] 8.2 创建主App组件
  - 组合所有子组件
  - 实现状态管理
  - 处理组件间通信
  - 实现完整的用户流程
  - _Requirements: 1.1-1.8, 2.1-2.5, 3.1-3.5, 4.1-4.5, 5.1-5.5, 6.1-6.5_

- [x] 8.3 添加全局错误边界
  - 捕获未处理的错误
  - 显示友好的错误页面
  - 提供恢复选项
  - _Requirements: 2.5_

- [ ]* 8.4 编写集成测试
  - 使用MSW模拟API
  - 测试完整上传分析流程
  - 测试历史记录流程
  - 测试错误恢复
  - _Requirements: 1.7, 2.1, 6.1_

- [x] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 优化性能和用户体验
- [x] 10.1 实现性能优化
  - 添加请求去重逻辑
  - 实现图片缓存
  - 优化存储容量管理（限制50条，清理30天前记录）
  - 添加代码分割
  - _Requirements: 1.4, 1.5, 8.2_

- [x] 10.2 添加用户体验增强
  - 实现图片质量检测提示
  - 添加改善建议
  - 优化加载状态显示
  - 添加估算值免责声明
  - _Requirements: 3.5, 9.1, 9.5_

- [x] 11. 配置部署
- [x] 11.1 配置Cloudflare Pages
  - 创建wrangler.toml配置
  - 配置构建命令和输出目录
  - 设置环境变量
  - 配置HTTPS和CSP策略
  - _Requirements: 7.1, 8.5, 10.1, 10.2, 10.3, 10.5_

- [x] 11.2 创建部署文档
  - 编写README.md
  - 说明环境变量配置
  - 提供部署步骤
  - 添加使用说明
  - _Requirements: 10.4_

- [x] 11.3 配置CI/CD
  - 创建GitHub Actions工作流
  - 配置自动测试
  - 配置自动部署
  - _Requirements: 10.4_

- [x] 12. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户


---

## P1 增强功能实施计划

- [x] 13. 更新TypeScript类型定义 (P1)
  - 添加MealType、MealRecord、BoundingBox等P1相关类型
  - 添加UserGoal、FavoriteFood、MealTemplate类型
  - 添加ReminderSettings、ChartDataPoint类型
  - 更新FoodItem接口添加boundingBox字段
  - _Requirements: 11.1-11.10, 12.1-12.15, 13.1-13.15, 14.1-14.15_

- [x] 14. 实现多食物识别功能
- [x] 14.1 创建ImageAnnotator组件
  - 实现图片显示和选择框绘制
  - 支持鼠标拖拽创建选择框
  - 支持多个选择框管理
  - 支持选择框调整和删除
  - 返回选择框坐标数组
  - _Requirements: 11.1, 11.2, 11.3_

- [ ]* 14.2 编写属性测试 - 选择框坐标传递
  - **Property 19: 选择框坐标传递完整性**
  - **Validates: Requirements 11.4**

- [x] 14.3 更新API客户端支持区域参数
  - 修改API请求接口支持boundingBox数组
  - 处理多食物识别响应
  - 添加边界框信息到结果
  - _Requirements: 11.4_

- [x] 14.4 创建MultiFoodResult组件
  - 显示多食物列表
  - 支持单个食物编辑和删除
  - 支持份量调整
  - 显示营养总计
  - _Requirements: 11.5, 11.6, 11.7, 11.8, 11.9_

- [ ]* 14.5 编写属性测试 - 多食物显示
  - **Property 20: 多食物列表显示完整性**
  - **Validates: Requirements 11.5**

- [ ]* 14.6 编写属性测试 - 边界框显示
  - **Property 21: 边界框信息显示**
  - **Validates: Requirements 11.6**

- [ ]* 14.7 编写属性测试 - 食物删除
  - **Property 22: 食物删除一致性**
  - **Validates: Requirements 11.7**

- [ ]* 14.8 编写属性测试 - 份量调整
  - **Property 23: 份量调整营养计算**
  - **Validates: Requirements 11.8**

- [ ]* 14.9 编写属性测试 - 营养总和
  - **Property 24: 多食物营养总和**
  - **Validates: Requirements 11.9**


- [x] 15. 实现餐次管理系统
- [x] 15.1 创建餐次数据服务
  - 实现mealService.ts
  - 实现CRUD操作
  - 实现日期范围查询
  - 实现餐次类型过滤
  - _Requirements: 12.1, 12.6, 12.15_

- [x] 15.2 创建MealTypeSelector组件
  - 显示四种餐次类型选项
  - 实现时间智能推荐
  - 支持手动选择
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ]* 15.3 编写属性测试 - 时间餐次映射
  - **Property 25: 时间到餐次类型映射**
  - **Validates: Requirements 12.2, 12.3, 12.4, 12.5**

- [x] 15.4 创建MealTimeline组件
  - 实现日期选择器
  - 按餐次分组显示记录
  - 显示每日目标和进度条
  - 支持展开/折叠餐次详情
  - _Requirements: 12.6, 12.7, 12.8_

- [ ]* 15.5 编写属性测试 - 餐次分组
  - **Property 26: 餐次分组显示**
  - **Validates: Requirements 12.6**

- [ ]* 15.6 编写属性测试 - 餐次展开
  - **Property 27: 餐次展开信息完整性**
  - **Validates: Requirements 12.8**

- [x] 15.7 创建收藏管理服务
  - 实现favoriteService.ts
  - 实现添加/删除收藏
  - 实现频率统计和排序
  - 实现最近食用查询
  - _Requirements: 12.9, 12.10, 12.11, 12.12_

- [ ]* 15.8 编写属性测试 - 收藏往返
  - **Property 28: 收藏食物往返一致性**
  - **Validates: Requirements 12.9**

- [ ]* 15.9 编写属性测试 - 频率排序
  - **Property 29: 常吃食物频率排序**
  - **Validates: Requirements 12.10**

- [ ]* 15.10 编写属性测试 - 时间过滤
  - **Property 30: 最近食用时间过滤**
  - **Validates: Requirements 12.11**

- [ ]* 15.11 编写属性测试 - 频率更新
  - **Property 31: 快速添加频率更新**
  - **Validates: Requirements 12.12**

- [x] 15.12 创建QuickAddPanel组件
  - 显示常吃食物网格
  - 显示最近食用列表
  - 实现一键添加功能
  - 集成收藏管理
  - _Requirements: 12.10, 12.11, 12.12_

- [x] 15.13 创建模板管理服务
  - 实现templateService.ts
  - 实现模板CRUD操作
  - 实现模板应用功能
  - _Requirements: 12.13, 12.14_

- [ ]* 15.14 编写属性测试 - 模板往返
  - **Property 32: 模板往返一致性**
  - **Validates: Requirements 12.13**

- [ ]* 15.15 编写属性测试 - 模板应用
  - **Property 33: 模板应用完整性**
  - **Validates: Requirements 12.14**

- [x] 15.16 创建TemplateManager组件
  - 显示模板列表
  - 支持创建/编辑模板
  - 支持应用模板到餐次
  - 支持删除模板
  - _Requirements: 12.13, 12.14_

- [ ]* 15.17 编写属性测试 - 餐次删除
  - **Property 34: 餐次删除一致性**
  - **Validates: Requirements 12.15**

- [x] 15.18 更新AnalysisDisplay集成餐次保存
  - 添加"保存到餐次"功能
  - 集成MealTypeSelector
  - 保存时关联餐次信息
  - _Requirements: 12.1_


- [x] 16. 实现数据可视化功能
- [x] 16.1 安装图表库
  - 安装recharts或chart.js
  - 配置图表库
  - 测试基本图表渲染
  - _Requirements: 13.1_

- [x] 16.2 创建图表数据服务
  - 实现chartDataService.ts
  - 实现时间范围数据聚合
  - 实现营养统计计算
  - 实现餐次分布计算
  - _Requirements: 13.14, 13.15_

- [ ]* 16.3 编写属性测试 - 时间范围过滤
  - **Property 38: 时间维度数据过滤**
  - **Validates: Requirements 13.11, 13.12, 13.13**

- [ ]* 16.4 编写属性测试 - 数据完整性
  - **Property 39: 时间范围数据完整性**
  - **Validates: Requirements 13.14**

- [ ]* 16.5 编写属性测试 - 平均计算
  - **Property 40: 平均卡路里计算准确性**
  - **Validates: Requirements 13.15**

- [x] 16.6 创建CalorieTrendChart组件
  - 实现折线图+柱状图组合
  - 显示目标线
  - 支持数据点点击
  - 添加数据标签
  - _Requirements: 13.1, 13.2, 13.3, 13.4_

- [ ]* 16.7 编写属性测试 - 目标线显示
  - **Property 35: 目标线显示**
  - **Validates: Requirements 13.3**

- [x] 16.8 创建NutritionRadarChart组件
  - 实现雷达图
  - 显示四个营养维度
  - 显示实际值vs目标值
  - 添加图例
  - _Requirements: 13.5, 13.6, 13.7_

- [ ]* 16.9 编写属性测试 - 雷达图双值
  - **Property 36: 雷达图双值显示**
  - **Validates: Requirements 13.7**

- [x] 16.10 创建MealDistributionChart组件
  - 实现饼图
  - 显示四种餐次占比
  - 支持扇区点击
  - 添加百分比标签
  - _Requirements: 13.8, 13.9, 13.10_

- [ ]* 16.11 编写属性测试 - 分布完整性
  - **Property 37: 餐次分布完整性**
  - **Validates: Requirements 13.9**

- [x] 16.12 创建TimePeriodSelector组件
  - 支持日/周/月切换
  - 触发数据重新加载
  - 显示当前选择
  - _Requirements: 13.11, 13.12, 13.13_

- [x] 16.13 创建DataAnalysis页面
  - 集成所有图表组件
  - 实现时间维度切换
  - 添加数据摘要卡片
  - 实现响应式布局
  - _Requirements: 13.1-13.15_


- [x] 17. 实现目标管理系统
- [x] 17.1 创建目标数据服务
  - 实现goalService.ts
  - 实现目标CRUD操作
  - 实现进度计算逻辑
  - 实现达标检查
  - _Requirements: 14.1-14.10_

- [ ]* 17.2 编写属性测试 - 目标验证
  - **Property 41: 目标验证**
  - **Validates: Requirements 14.5**

- [ ]* 17.3 编写属性测试 - 进度计算
  - **Property 42: 进度百分比计算**
  - **Validates: Requirements 14.6**

- [ ]* 17.4 编写属性测试 - 连续达标
  - **Property 43: 连续达标徽章显示**
  - **Validates: Requirements 14.9**

- [x] 17.5 创建GoalSetup组件
  - 实现目标类型选择
  - 实现体重目标输入
  - 实现营养目标输入
  - 实现日期选择
  - 添加表单验证
  - _Requirements: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 17.6 创建GoalProgress组件
  - 显示进度百分比
  - 显示已坚持天数
  - 显示预计剩余天数
  - 添加进度条动画
  - _Requirements: 14.6, 14.7, 14.8_

- [x] 17.7 创建GoalCard组件
  - 显示目标概览
  - 显示每日达成情况
  - 显示营养素对比
  - 显示连续达标徽章
  - 添加编辑/暂停按钮
  - _Requirements: 14.9, 14.10_

- [x] 17.8 创建提醒服务
  - 实现reminderService.ts
  - 请求通知权限
  - 实现定时提醒调度
  - 发送浏览器通知
  - 处理通知点击事件
  - _Requirements: 14.11, 14.12, 14.13, 14.14, 14.15_

- [ ]* 17.9 编写属性测试 - 权限请求
  - **Property 44: 提醒权限请求**
  - **Validates: Requirements 14.14**

- [ ]* 17.10 编写属性测试 - 通知导航
  - **Property 45: 通知点击导航**
  - **Validates: Requirements 14.15**

- [x] 17.11 创建ReminderSettings组件
  - 实现用餐提醒设置
  - 实现饮水提醒设置
  - 实现记录提醒设置
  - 保存提醒配置
  - _Requirements: 14.11, 14.12, 14.13_

- [x] 17.12 创建GoalManagement页面
  - 集成所有目标组件
  - 实现页面布局
  - 添加导航
  - _Requirements: 14.1-14.15_


- [x] 18. P1集成与优化
- [x] 18.1 更新主应用路由
  - 添加餐次管理路由
  - 添加数据分析路由
  - 添加目标管理路由
  - 更新导航菜单
  - 添加底部导航栏
  - _Requirements: 所有P1需求_

- [x] 18.2 创建自定义Hooks
  - 创建useMealRecords.ts
  - 创建useGoalProgress.ts
  - 创建useChartData.ts
  - 创建useFavorites.ts
  - 优化数据获取逻辑
  - _Requirements: 所有P1需求_

- [x] 18.3 性能优化
  - 添加React.memo优化组件
  - 使用useMemo缓存计算
  - 使用useCallback优化回调
  - 实现图表数据采样
  - 优化存储查询
  - _Requirements: 所有P1需求_

- [x] 18.4 存储优化
  - 实现数据分片存储
  - 添加日期索引
  - 实现自动清理策略
  - 添加存储容量监控
  - _Requirements: 所有P1需求_

- [ ]* 18.5 编写集成测试
  - 测试多食物识别流程
  - 测试餐次管理流程
  - 测试图表数据流
  - 测试目标追踪流程
  - _Requirements: 所有P1需求_

- [x] 19. P1检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 20. P1最终验收
- [x] 20.1 功能验收测试
  - 测试多食物识别所有功能
  - 测试餐次管理所有功能
  - 测试数据可视化所有功能
  - 测试目标管理所有功能
  - _Requirements: 所有P1需求_

- [x] 20.2 用户体验优化
  - 优化加载状态
  - 优化错误提示
  - 优化交互反馈
  - 优化移动端体验
  - _Requirements: 所有P1需求_

- [x] 20.3 文档更新
  - 更新README.md
  - 添加P1功能说明
  - 更新使用指南
  - 添加截图和演示
  - _Requirements: 所有P1需求_


---

## 测试完善和质量保证

### 属性测试实现（可选）

以下属性测试任务是可选的，用于提供更全面的正确性保证。如果时间允许，建议实现这些测试以提高代码质量。

- [ ]* 21. 核心功能属性测试
- [ ]* 21.1 图片处理属性测试
  - **Property 1: 文件格式验证正确性** - 验证JPEG/PNG/WebP格式接受，其他格式拒绝
  - **Property 2: 图片分辨率检测准确性** - 验证检测的分辨率与实际匹配
  - **Property 3: 高分辨率图片压缩** - 验证超过1280px的图片被正确压缩
  - **Property 4: 大文件压缩** - 验证超过2MB的文件被压缩
  - **Property 5: 压缩后预览可用性** - 验证压缩后返回有效的DataURL
  - _Requirements: 1.1, 1.3, 1.4, 1.5, 1.6_

- [ ]* 21.2 数据解析属性测试
  - **Property 6: API响应解析完整性** - 验证所有食物名称被正确提取
  - **Property 7: 多食物列表完整性** - 验证食物列表长度与响应匹配
  - **Property 8: 卡路里数据存在性** - 验证每个食物都有非负卡路里值
  - **Property 9: 卡路里单位一致性** - 验证单位标注为"kcal"
  - **Property 10: 卡路里总和正确性** - 验证总卡路里等于各食物之和
  - **Property 11: 营养成分数据完整性** - 验证包含四个营养字段
  - **Property 12: 营养成分结构化格式** - 验证标准结构
  - _Requirements: 2.2, 2.3, 3.1, 3.2, 3.3, 4.1-4.5_

- [ ]* 21.3 存储属性测试
  - **Property 13: 历史记录存储往返一致性** - 验证保存后读取数据一致
  - **Property 14: 历史记录显示完整性** - 验证显示包含所有必需字段
  - **Property 15: 历史记录删除一致性** - 验证删除后查询返回null
  - _Requirements: 6.1, 6.3, 6.5_

- [ ]* 21.4 API集成属性测试
  - **Property 16: API请求图片压缩验证** - 验证发送的图片已压缩
  - **Property 17: 临时文件清理** - 验证处理后临时文件被删除
  - **Property 18: 结果过滤正确性** - 验证非食物对象被过滤
  - _Requirements: 8.2, 8.3, 9.4_

- [ ]* 22. P1功能属性测试
- [ ]* 22.1 多食物识别属性测试
  - **Property 19: 选择框坐标传递完整性** - 验证所有选择框坐标被传递
  - **Property 20: 多食物列表显示完整性** - 验证显示数量与识别数量匹配
  - **Property 21: 边界框信息显示** - 验证边界框位置信息被显示
  - **Property 22: 食物删除一致性** - 验证删除后列表长度减1
  - **Property 23: 份量调整营养计算** - 验证份量调整后营养值正确缩放
  - **Property 24: 多食物营养总和** - 验证总营养等于各食物之和
  - _Requirements: 11.4, 11.5, 11.6, 11.7, 11.8, 11.9_

- [ ]* 22.2 餐次管理属性测试
  - **Property 25: 时间到餐次类型映射** - 验证时间段正确映射到餐次类型
  - **Property 26: 餐次分组显示** - 验证分组后每组只包含对应类型
  - **Property 27: 餐次展开信息完整性** - 验证展开显示包含所有食物和小计
  - **Property 28: 收藏食物往返一致性** - 验证收藏后检索数据一致
  - **Property 29: 常吃食物频率排序** - 验证按频率降序排列
  - **Property 30: 最近食用时间过滤** - 验证最近7天内的食物
  - **Property 31: 快速添加频率更新** - 验证使用频率增加1
  - **Property 32: 模板往返一致性** - 验证模板保存后读取一致
  - **Property 33: 模板应用完整性** - 验证应用后包含所有食物
  - **Property 34: 餐次删除一致性** - 验证删除后查询返回undefined
  - _Requirements: 12.2-12.5, 12.6, 12.8, 12.9-12.15_

- [ ]* 22.3 数据可视化属性测试
  - **Property 35: 目标线显示** - 验证设置目标后显示目标线
  - **Property 36: 雷达图双值显示** - 验证同时显示实际值和目标值
  - **Property 37: 餐次分布完整性** - 验证包含所有四种餐次类型
  - **Property 38: 时间维度数据过滤** - 验证只包含时间范围内的数据
  - **Property 39: 时间范围数据完整性** - 验证包含范围内所有记录
  - **Property 40: 平均卡路里计算准确性** - 验证平均值计算正确
  - _Requirements: 13.3, 13.7, 13.9, 13.11-13.15_

- [ ]* 22.4 目标管理属性测试
  - **Property 41: 目标验证** - 验证缺少必填字段时保存失败
  - **Property 42: 进度百分比计算** - 验证进度百分比计算公式正确
  - **Property 43: 连续达标徽章显示** - 验证连续达标≥3天显示徽章
  - **Property 44: 提醒权限请求** - 验证未授权时请求权限
  - **Property 45: 通知点击导航** - 验证点击通知导航到对应页面
  - _Requirements: 14.5, 14.6, 14.9, 14.14, 14.15_


---

## 功能增强和优化建议

以下是基于当前实现状态的改进建议，可根据优先级选择实施：

- [x] 23. 用户体验优化
- [x] 23.1 添加加载骨架屏
  - 在数据加载时显示骨架屏而非简单的loading文本
  - 提升用户感知性能
  - _Requirements: 5.1, 5.2_

- [x] 23.2 实现离线支持
  - 使用Service Worker缓存静态资源
  - 支持离线查看历史记录
  - 显示离线状态提示
  - _Requirements: 10.1_

- [x] 23.3 添加数据导出功能
  - 支持导出历史记录为CSV/JSON
  - 支持导出图表为图片
  - 支持导出营养报告为PDF
  - _Requirements: 6.2_

- [x] 23.4 优化移动端体验
  - 改进触摸手势支持
  - 优化图表在小屏幕上的显示
  - 添加下拉刷新功能
  - _Requirements: 5.5_

- [x] 24. 性能优化
- [x] 24.1 实现虚拟滚动
  - 在历史记录列表中使用虚拟滚动
  - 优化大量数据的渲染性能
  - _Requirements: 6.2_

- [x] 24.2 优化图片加载
  - 实现图片懒加载
  - 添加渐进式图片加载
  - 使用缩略图优化列表显示
  - _Requirements: 1.6, 6.3_

- [x] 24.3 代码分割优化
  - 按路由分割代码
  - 延迟加载图表库
  - 优化首屏加载时间
  - _Requirements: 10.1_

- [-] 25. 功能增强
- [x] 25.1 添加食物搜索功能
  - 在历史记录中搜索特定食物
  - 支持模糊搜索
  - 显示搜索建议
  - _Requirements: 6.2_

- [ ] 25.2 实现数据同步
  - 支持账户登录（可选）
  - 云端数据备份
  - 多设备数据同步
  - _Requirements: 6.1_

- [x] 25.3 添加社交分享功能
  - 分享分析结果到社交媒体
  - 生成精美的分享卡片
  - 支持二维码分享
  - _Requirements: 5.3_

- [x] 25.4 实现AI建议功能
  - 基于历史数据提供饮食建议
  - 智能推荐健康食物
  - 提供营养均衡建议
  - _Requirements: 9.5_


---

## 测试和文档

- [ ]* 26. 集成测试
- [ ]* 26.1 端到端测试
  - 测试完整的上传-分析-保存流程
  - 测试多食物识别流程
  - 测试餐次管理流程
  - 测试目标追踪流程
  - _Requirements: 所有核心需求_

- [ ]* 26.2 性能测试
  - 测试大图片处理性能
  - 测试大量历史记录的加载性能
  - 测试图表渲染性能
  - _Requirements: 1.4, 1.5, 6.2, 13.1-13.15_

- [ ] 27. 文档完善
- [ ] 27.1 API文档
  - 编写Workers API文档
  - 说明请求/响应格式
  - 提供示例代码
  - _Requirements: 7.1-7.5, 8.1-8.5_

- [ ] 27.2 用户指南
  - 编写详细的使用教程
  - 添加功能说明视频
  - 提供常见问题解答
  - _Requirements: 所有功能需求_

- [ ] 27.3 开发者文档
  - 编写架构设计文档
  - 说明代码组织结构
  - 提供贡献指南
  - _Requirements: 10.4_


---

## P2 盈利模式实施计划

### 配额管理系统

- [ ] 28. 实现配额管理核心功能
- [ ] 28.1 创建配额数据模型和类型定义
  - 定义UserQuota、QuotaTransaction、AdConfig接口
  - 添加配额相关的枚举类型
  - 更新LocalStorageSchema包含配额数据
  - _Requirements: 15.1, 15.11_

- [ ] 28.2 实现配额服务（quotaService.ts）
  - 实现getUserQuota函数（获取用户配额）
  - 实现hasAvailableQuota函数（检查配额可用性）
  - 实现useQuota函数（使用配额）
  - 实现earnQuotaFromAd函数（通过广告增加配额）
  - 实现配额持久化逻辑
  - _Requirements: 15.1, 15.2, 15.6, 15.11_

- [x] 28.3 实现用户识别机制
  - 实现设备指纹生成函数
  - 实现用户ID管理
  - 实现管理员识别逻辑
  - 支持管理员密码验证（可选）
  - _Requirements: 15.8, 17.4_

- [ ]* 28.4 编写属性测试 - 配额管理
  - **Property 46: 配额扣减一致性** - 验证识别后配额减1
  - **Property 47: 配额增加一致性** - 验证观看广告后配额加3
  - **Property 48: 管理员无限配额** - 验证管理员配额检查始终通过
  - **Property 49: 配额非负性** - 验证配额始终≥0
  - **Property 50: 配额持久化一致性** - 验证配额保存后读取一致
  - _Requirements: 15.1, 15.2, 15.6, 15.8, 15.11_

- [ ] 28.5 实现配额历史记录
  - 实现QuotaTransaction记录功能
  - 实现配额历史查询
  - 实现配额统计功能
  - 支持导出配额使用报告
  - _Requirements: 17.6, 17.7_

### 广告系统集成

- [ ] 29. 实现广告系统
- [ ] 29.1 选择和配置广告提供商
  - 研究Google AdSense激励视频广告
  - 注册广告账号并获取广告单元ID
  - 配置广告参数（类型、时长、奖励）
  - 创建广告配置文件
  - _Requirements: 17.1, 17.2, 17.5_

- [ ] 29.2 实现广告服务（adService.ts）
  - 实现广告SDK初始化
  - 实现广告加载函数
  - 实现广告显示函数
  - 实现广告完成回调处理
  - 实现广告错误处理
  - _Requirements: 15.5, 15.6, 15.7, 17.8_

- [ ] 29.3 创建AdPlayer组件
  - 实现广告播放器UI
  - 显示广告加载状态
  - 显示广告播放进度
  - 处理广告完成/跳过事件
  - 实现广告错误提示
  - _Requirements: 15.5, 15.6, 15.7, 16.8, 16.9_

- [ ] 29.4 集成广告SDK到项目
  - 安装广告SDK依赖
  - 配置广告SDK初始化脚本
  - 实现广告预加载逻辑
  - 测试广告加载和播放
  - _Requirements: 15.15, 17.1_

### UI组件开发

- [ ] 30. 实现配额相关UI组件
- [ ] 30.1 创建QuotaIndicator组件
  - 在顶部导航栏显示配额图标
  - 显示剩余配额数量
  - 配额不足时显示警告样式
  - 点击打开配额详情弹窗
  - 管理员显示特殊标识
  - _Requirements: 16.1, 16.4, 16.10_

- [ ] 30.2 创建QuotaModal组件
  - 实现配额详情弹窗UI
  - 显示基础配额和试玩配额
  - 显示配额使用历史
  - 提供"观看广告"按钮
  - 显示配额获取方式说明
  - _Requirements: 16.2, 16.3, 16.6_

- [ ] 30.3 创建QuotaGuard组件
  - 包装ImageUploader组件
  - 上传前检查配额
  - 配额不足时显示提示
  - 提供"观看广告"快捷入口
  - _Requirements: 15.3, 15.4, 16.5_

- [ ] 30.4 更新ImageUploader集成配额检查
  - 在上传前调用配额检查
  - 配额可用时正常上传
  - 配额不足时阻止上传并提示
  - 显示配额用尽提示和广告入口
  - _Requirements: 15.3, 15.4, 16.5_

### 流程集成

- [ ] 31. 集成配额和广告流程
- [ ] 31.1 实现完整的配额检查流程
  - 在食物识别前检查配额
  - 配额可用时扣减配额并继续
  - 配额不足时显示广告入口
  - 管理员跳过配额检查
  - _Requirements: 15.2, 15.3, 15.8_

- [ ] 31.2 实现广告观看奖励流程
  - 用户点击"观看广告"按钮
  - 加载并播放广告
  - 完整观看后增加配额
  - 显示成功提示和新配额
  - 中途关闭时不增加配额
  - _Requirements: 15.5, 15.6, 15.7, 16.7_

- [ ] 31.3 实现配额状态同步
  - 多标签页配额状态同步
  - 使用localStorage事件监听
  - 实时更新UI显示
  - 避免配额重复扣减
  - _Requirements: 15.11_

- [ ] 31.4 实现配额数据校验和恢复
  - 启动时验证配额数据完整性
  - 检测异常数据并重置
  - 记录配额重置日志
  - 通知用户配额已重置
  - _Requirements: 15.13_

### 配置和管理

- [ ] 32. 实现配额配置和管理功能
- [ ] 32.1 创建配额配置文件
  - 定义默认配额规则（基础5次，广告3次）
  - 配置广告参数（类型、时长、奖励）
  - 配置管理员列表
  - 支持环境变量覆盖
  - _Requirements: 17.2, 17.3, 17.4, 17.5_

- [ ] 32.2 实现管理员管理界面（可选）
  - 创建管理员登录页面
  - 实现密码验证
  - 显示配额统计数据
  - 支持重置用户配额
  - _Requirements: 17.4, 17.9_

- [ ] 32.3 实现配额使用统计
  - 记录配额使用日志
  - 统计每日/每周/每月使用量
  - 统计广告观看次数
  - 支持导出统计报告
  - _Requirements: 17.6, 17.7_

### 测试和优化

- [ ]* 33. 配额系统测试
- [ ]* 33.1 单元测试
  - 测试配额服务各个函数
  - 测试用户识别逻辑
  - 测试配额持久化
  - 测试管理员识别
  - _Requirements: 15.1-15.15_

- [ ]* 33.2 集成测试
  - 测试完整的配额检查流程
  - 测试广告观看奖励流程
  - 测试配额用尽场景
  - 测试管理员无限配额
  - _Requirements: 15.1-15.15, 16.1-16.10_

- [ ]* 33.3 广告系统测试
  - 测试广告加载
  - 测试广告播放
  - 测试广告完成回调
  - 测试广告错误处理
  - _Requirements: 15.5-15.7, 16.8, 16.9_

- [ ] 34. 性能和用户体验优化
- [ ] 34.1 广告性能优化
  - 实现广告预加载
  - 优化广告加载时间
  - 添加广告加载进度指示
  - 实现广告缓存机制
  - _Requirements: 15.15, 16.8_

- [ ] 34.2 配额UI优化
  - 优化配额显示动画
  - 添加配额变化提示
  - 优化低配额警告
  - 改进配额详情展示
  - _Requirements: 16.1-16.7_

- [ ] 34.3 错误处理优化
  - 完善广告加载失败处理
  - 优化配额数据异常恢复
  - 添加友好的错误提示
  - 实现降级方案
  - _Requirements: 15.13, 16.9, 17.8_

### 文档和部署

- [ ] 35. P2文档和部署
- [ ] 35.1 更新用户文档
  - 说明配额系统使用方法
  - 说明如何通过广告获取配额
  - 添加常见问题解答
  - 提供配额管理指南
  - _Requirements: 16.1-16.10_

- [ ] 35.2 更新开发者文档
  - 说明配额系统架构
  - 说明广告集成方法
  - 提供配置指南
  - 添加API文档
  - _Requirements: 17.1-17.10_

- [ ] 35.3 配置生产环境
  - 配置广告账号和密钥
  - 设置管理员列表
  - 配置配额规则
  - 测试生产环境广告
  - _Requirements: 17.5_

- [ ] 35.4 监控和分析
  - 实现配额使用监控
  - 实现广告观看统计
  - 配置错误日志收集
  - 设置运营数据看板
  - _Requirements: 17.6, 17.7_

- [ ] 36. P2最终验收
  - 测试配额系统所有功能
  - 测试广告系统所有功能
  - 测试管理员功能
  - 验证配额数据持久化
  - 验证多场景下的用户体验
  - _Requirements: 15.1-15.15, 16.1-16.10, 17.1-17.10_

