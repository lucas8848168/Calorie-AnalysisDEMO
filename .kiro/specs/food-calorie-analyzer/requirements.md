# 需求文档

## 简介

食物卡路里分析系统是一个基于Web的应用程序，允许用户上传食物图片，系统通过集成方舟豆包1.6大模型来识别食物类型、计算卡路里含量并分析营养成分。该系统旨在帮助用户更好地了解饮食营养信息，支持健康饮食管理。

## 术语表

- **系统 (System)**: 食物卡路里分析Web应用程序
- **用户 (User)**: 使用该应用程序的最终用户
- **管理员 (Administrator)**: 拥有无限识别配额的特权用户
- **方舟豆包模型 (Ark Doubao Model)**: 字节跳动的方舟豆包1.6大语言模型API
- **食物识别 (Food Recognition)**: 通过图像识别技术识别食物类型的过程
- **营养成分 (Nutritional Information)**: 包括卡路里、蛋白质、脂肪、碳水化合物等营养数据
- **分析结果 (Analysis Result)**: 包含食物识别结果和营养成分信息的完整输出
- **识别配额 (Recognition Quota)**: 用户可用的食物识别次数限制
- **试玩机会 (Trial Opportunity)**: 通过观看广告获得的额外识别次数
- **广告提供商 (Ad Provider)**: 提供广告服务的第三方平台
- **餐次 (Meal)**: 用户的一次进食记录，包括早餐、午餐、晚餐或加餐
- **餐次类型 (Meal Type)**: 餐次的分类，包括早餐、午餐、晚餐、加餐四种类型
- **边界框 (Bounding Box)**: 标识图片中食物位置的矩形区域坐标
- **常吃食物 (Favorite Food)**: 用户收藏的经常食用的食物项
- **饮食模板 (Meal Template)**: 用户保存的常用食物组合，可快速应用到餐次
- **目标 (Goal)**: 用户设定的健康目标，包括减重、增肌、维持或健康目标
- **进度 (Progress)**: 用户当前目标的完成百分比和达成情况
- **提醒 (Reminder)**: 系统发送的定时通知，包括用餐提醒、饮水提醒和记录提醒

## 需求

### 需求 1

**用户故事:** 作为用户，我希望能够上传食物图片，以便系统可以识别食物并分析其营养成分

#### 验收标准

1. WHEN 用户选择一张图片文件 THEN 系统 SHALL 验证文件格式为支持的图片类型（JPEG、PNG、WebP）
2. WHEN 用户上传的图片文件大小超过10MB THEN 系统 SHALL 拒绝上传并显示错误提示信息
3. WHEN 系统接收到有效图片 THEN 系统 SHALL 检测图片的分辨率和文件大小
4. WHEN 图片分辨率超过2048x2048像素 THEN 系统 SHALL 将图片压缩至合适尺寸以节省token消耗
5. WHEN 图片文件大小超过2MB THEN 系统 SHALL 在保持可识别质量的前提下压缩图片
6. WHEN 图片压缩完成 THEN 系统 SHALL 在界面上显示处理后的图片预览
7. WHEN 图片预处理完成 THEN 系统 SHALL 将优化后的图片数据发送至方舟豆包模型进行分析
8. WHEN 用户上传空文件或损坏的图片 THEN 系统 SHALL 拒绝处理并提示用户重新上传有效图片

### 需求 2

**用户故事:** 作为用户，我希望系统能够准确识别图片中的食物类型，以便我了解我吃的是什么

#### 验收标准

1. WHEN 系统接收到有效的食物图片 THEN 系统 SHALL 调用方舟豆包模型API识别图片中的食物类型
2. WHEN 方舟豆包模型返回识别结果 THEN 系统 SHALL 提取并显示食物名称
3. WHEN 图片中包含多种食物 THEN 系统 SHALL 列出所有识别到的食物类型
4. WHEN 图片中没有可识别的食物 THEN 系统 SHALL 提示用户图片中未检测到食物
5. WHEN API调用失败或超时 THEN 系统 SHALL 显示友好的错误信息并允许用户重试

### 需求 3

**用户故事:** 作为用户，我希望系统能够计算食物的卡路里含量，以便我管理每日热量摄入

#### 验收标准

1. WHEN 系统识别出食物类型 THEN 系统 SHALL 通过方舟豆包模型估算该食物的卡路里含量
2. WHEN 系统计算卡路里 THEN 系统 SHALL 以千卡（kcal）为单位显示结果
3. WHEN 图片中包含多种食物 THEN 系统 SHALL 分别显示每种食物的卡路里并计算总和
4. WHEN 系统无法准确估算卡路里 THEN 系统 SHALL 提供一个合理的范围值
5. WHEN 显示卡路里信息 THEN 系统 SHALL 标注这是基于标准份量的估算值

### 需求 4

**用户故事:** 作为用户，我希望查看食物的详细营养成分，以便我全面了解饮食营养

#### 验收标准

1. WHEN 系统识别出食物 THEN 系统 SHALL 显示蛋白质含量（克）
2. WHEN 系统识别出食物 THEN 系统 SHALL 显示脂肪含量（克）
3. WHEN 系统识别出食物 THEN 系统 SHALL 显示碳水化合物含量（克）
4. WHEN 系统识别出食物 THEN 系统 SHALL 显示膳食纤维含量（克）
5. WHEN 系统识别出食物 THEN 系统 SHALL 以结构化格式展示所有营养成分信息

### 需求 5

**用户故事:** 作为用户，我希望系统响应快速且界面友好，以便我获得良好的使用体验

#### 验收标准

1. WHEN 用户上传图片后 THEN 系统 SHALL 在3秒内显示加载状态指示器
2. WHEN 系统正在处理图片 THEN 系统 SHALL 显示处理进度或加载动画
3. WHEN 分析完成 THEN 系统 SHALL 以清晰易读的方式展示结果
4. WHEN 用户查看分析结果 THEN 系统 SHALL 提供"重新分析"或"上传新图片"的选项
5. WHEN 系统在移动设备上运行 THEN 系统 SHALL 保持响应式布局和良好的触摸交互

### 需求 6

**用户故事:** 作为用户，我希望能够查看历史分析记录，以便追踪我的饮食情况

#### 验收标准

1. WHEN 用户完成一次食物分析 THEN 系统 SHALL 将结果保存到本地存储
2. WHEN 用户访问历史记录页面 THEN 系统 SHALL 显示最近的分析记录列表
3. WHEN 显示历史记录 THEN 系统 SHALL 包含缩略图、食物名称、卡路里和分析时间
4. WHEN 用户点击历史记录项 THEN 系统 SHALL 显示该记录的完整营养分析详情
5. WHEN 用户删除历史记录 THEN 系统 SHALL 从本地存储中移除该记录并更新列表

### 需求 7

**用户故事:** 作为开发者，我希望能够安全地配置和管理API密钥，以便系统可以调用方舟豆包API服务

#### 验收标准

1. WHEN 系统部署时 THEN 系统 SHALL 从环境变量中读取方舟豆包API密钥
2. WHEN 系统启动时 THEN 系统 SHALL 验证API密钥是否已配置且格式有效
3. WHEN API密钥未配置 THEN 系统 SHALL 在日志中记录错误并拒绝启动
4. WHEN 系统存储API密钥 THEN 系统 SHALL 确保密钥不会出现在代码仓库或前端代码中
5. WHEN 系统使用API密钥 THEN 系统 SHALL 仅在后端服务器中访问密钥进行API调用

### 需求 8

**用户故事:** 作为开发者，我希望系统能够安全地集成方舟豆包API，以便保护用户数据和优化token使用

#### 验收标准

1. WHEN 系统调用方舟豆包API THEN 系统 SHALL 通过后端服务器发送请求而非直接从前端调用
2. WHEN 系统发送图片到API THEN 系统 SHALL 使用压缩后的图片以减少token消耗
3. WHEN 系统处理用户上传的图片 THEN 系统 SHALL 在分析完成后删除服务器上的临时文件
4. WHEN API请求失败 THEN 系统 SHALL 记录错误日志但不向用户暴露敏感信息
5. WHEN 系统传输图片数据 THEN 系统 SHALL 使用HTTPS协议确保数据传输安全

### 需求 9

**用户故事:** 作为用户，我希望系统能够处理各种图片质量和拍摄角度，以便在不同场景下都能使用

#### 验收标准

1. WHEN 用户上传低分辨率图片 THEN 系统 SHALL 检测分辨率并在结果中标注可能的准确度影响
2. WHEN 图片中食物被部分遮挡 THEN 系统 SHALL 基于可见部分进行识别并标注不确定性
3. WHEN 图片光线条件不佳 THEN 系统 SHALL 尝试识别并提示用户可能影响准确性
4. WHEN 图片包含非食物对象 THEN 系统 SHALL 过滤掉非食物项并仅显示食物相关结果
5. WHEN 系统检测到图片质量问题 THEN 系统 SHALL 提供改善建议给用户

### 需求 10

**用户故事:** 作为开发者，我希望系统能够部署到免费的托管平台，以便降低运营成本并便于参加编程竞赛

#### 验收标准

1. WHEN 系统架构设计完成 THEN 系统 SHALL 支持部署到GitHub Pages或Cloudflare Pages
2. WHEN 系统使用静态资源 THEN 系统 SHALL 确保所有前端资源可以通过静态托管服务访问
3. WHEN 系统需要后端服务 THEN 系统 SHALL 使用Serverless函数（如Cloudflare Workers或Vercel Functions）
4. WHEN 系统部署配置 THEN 系统 SHALL 提供自动化部署脚本或配置文件
5. WHEN 系统在免费平台运行 THEN 系统 SHALL 优化资源使用以符合免费额度限制


---

## P1 增强需求

### 需求 11

**用户故事:** 作为用户，我希望能够识别图片中的多个食物并分别管理它们，以便我准确记录复杂餐食的营养信息

#### 验收标准

1. WHEN 用户上传包含多个食物的图片 THEN 系统 SHALL 提供手动框选特定食物区域的功能
2. WHEN 用户在图片上拖拽鼠标 THEN 系统 SHALL 绘制可调整的选择框
3. WHEN 用户创建多个选择框 THEN 系统 SHALL 支持同时标注多个食物区域
4. WHEN 用户完成区域选择 THEN 系统 SHALL 将每个区域的坐标信息传递给识别API
5. WHEN 系统识别多个食物 THEN 系统 SHALL 以列表形式分别显示每个食物的名称和营养信息
6. WHEN 用户查看多食物识别结果 THEN 系统 SHALL 显示每个食物的边界框位置信息
7. WHEN 用户编辑多食物结果 THEN 系统 SHALL 允许删除或修改单个食物项
8. WHEN 用户调整食物份量 THEN 系统 SHALL 实时重新计算该食物的营养信息
9. WHEN 系统显示多食物结果 THEN 系统 SHALL 计算并显示所有食物的营养总和
10. WHEN 用户选择"分析全部"选项 THEN 系统 SHALL 自动识别图片中的所有食物而无需手动框选

### 需求 12

**用户故事:** 作为用户，我希望能够按餐次管理我的饮食记录，以便我更好地追踪每日的饮食习惯

#### 验收标准

1. WHEN 用户保存分析结果 THEN 系统 SHALL 提供选择餐次类型的选项（早餐、午餐、晚餐、加餐）
2. WHEN 系统根据当前时间判断餐次 THEN 系统 SHALL 在5:00-10:00时段推荐早餐类型
3. WHEN 系统根据当前时间判断餐次 THEN 系统 SHALL 在11:00-14:00时段推荐午餐类型
4. WHEN 系统根据当前时间判断餐次 THEN 系统 SHALL 在17:00-21:00时段推荐晚餐类型
5. WHEN 系统根据当前时间判断餐次 THEN 系统 SHALL 在其他时段推荐加餐类型
6. WHEN 用户查看某一天的饮食记录 THEN 系统 SHALL 以时间轴形式按餐次分组显示所有记录
7. WHEN 用户查看餐次时间轴 THEN 系统 SHALL 显示每日卡路里目标和当前摄入进度
8. WHEN 用户点击某个餐次 THEN 系统 SHALL 展开显示该餐次包含的所有食物及小计营养信息
9. WHEN 用户添加常吃食物到收藏 THEN 系统 SHALL 保存该食物信息并记录使用频率
10. WHEN 用户访问快速添加面板 THEN 系统 SHALL 显示按使用频率排序的常吃食物列表
11. WHEN 用户访问快速添加面板 THEN 系统 SHALL 显示最近7天内食用过的食物列表
12. WHEN 用户从快速添加面板选择食物 THEN 系统 SHALL 将该食物添加到指定餐次并更新使用频率
13. WHEN 用户创建饮食模板 THEN 系统 SHALL 保存该模板包含的所有食物和总营养信息
14. WHEN 用户应用饮食模板 THEN 系统 SHALL 将模板中的所有食物添加到指定餐次
15. WHEN 用户删除餐次记录 THEN 系统 SHALL 从存储中移除该记录并更新每日统计

### 需求 13

**用户故事:** 作为用户，我希望能够通过图表可视化我的饮食数据，以便我发现饮食模式和趋势

#### 验收标准

1. WHEN 用户访问数据分析页面 THEN 系统 SHALL 显示卡路里趋势图表
2. WHEN 系统绘制卡路里趋势图 THEN 系统 SHALL 使用折线图和柱状图组合展示每日卡路里摄入
3. WHEN 系统显示卡路里趋势图 THEN 系统 SHALL 在图表上标注用户设定的每日目标线
4. WHEN 用户点击趋势图上的数据点 THEN 系统 SHALL 显示该日期的详细饮食记录
5. WHEN 用户访问数据分析页面 THEN 系统 SHALL 显示营养均衡雷达图
6. WHEN 系统绘制营养雷达图 THEN 系统 SHALL 展示蛋白质、脂肪、碳水化合物、膳食纤维四个维度
7. WHEN 系统显示营养雷达图 THEN 系统 SHALL 同时显示实际摄入值和目标值的对比
8. WHEN 用户访问数据分析页面 THEN 系统 SHALL 显示餐次分布饼图
9. WHEN 系统绘制餐次分布图 THEN 系统 SHALL 展示早餐、午餐、晚餐、加餐各自的卡路里占比
10. WHEN 用户点击餐次分布图的某个扇区 THEN 系统 SHALL 显示该餐次的详细信息
11. WHEN 用户切换时间维度到日视图 THEN 系统 SHALL 显示当天各餐次的详细数据
12. WHEN 用户切换时间维度到周视图 THEN 系统 SHALL 显示最近7天的趋势数据
13. WHEN 用户切换时间维度到月视图 THEN 系统 SHALL 显示最近30天的趋势数据
14. WHEN 系统计算图表数据 THEN 系统 SHALL 从存储中读取指定时间范围内的所有餐次记录
15. WHEN 系统显示数据摘要 THEN 系统 SHALL 计算并显示平均每日卡路里、营养均衡度评分

### 需求 14

**用户故事:** 作为用户，我希望能够设定健康目标并追踪进度，以便我保持动力并实现健康目标

#### 验收标准

1. WHEN 用户创建新目标 THEN 系统 SHALL 提供减重、增肌、维持、健康四种目标类型选项
2. WHEN 用户设定减重目标 THEN 系统 SHALL 要求输入当前体重、目标体重和目标日期
3. WHEN 用户设定目标 THEN 系统 SHALL 要求输入每日卡路里目标值
4. WHEN 用户设定目标 THEN 系统 SHALL 要求输入每日蛋白质、脂肪、碳水化合物、膳食纤维的目标值
5. WHEN 用户保存目标 THEN 系统 SHALL 验证所有必填字段已填写且数值合理
6. WHEN 系统计算目标进度 THEN 系统 SHALL 比较每日实际摄入与目标值计算达成百分比
7. WHEN 系统显示目标进度 THEN 系统 SHALL 展示已坚持天数和预计剩余天数
8. WHEN 系统显示目标进度 THEN 系统 SHALL 使用进度条可视化展示目标完成度
9. WHEN 用户连续达标3天或更多 THEN 系统 SHALL 显示连续达标天数徽章
10. WHEN 用户查看目标卡片 THEN 系统 SHALL 显示当日目标达成情况和各营养素摄入对比
11. WHEN 用户启用用餐提醒 THEN 系统 SHALL 在用户设定的早餐、午餐、晚餐时间发送浏览器通知
12. WHEN 用户启用饮水提醒 THEN 系统 SHALL 按设定的时间间隔在指定时段内发送提醒通知
13. WHEN 用户启用记录提醒 THEN 系统 SHALL 在每日设定时间提醒用户记录饮食
14. WHEN 系统发送提醒通知 THEN 系统 SHALL 请求浏览器通知权限（如未授权）
15. WHEN 用户点击提醒通知 THEN 系统 SHALL 打开应用并导航到相应的功能页面


---

## P2 盈利模式需求

### 需求 15

**用户故事:** 作为产品运营者，我希望实现用户配额限制和广告试玩系统，以便实现应用的可持续运营和盈利

#### 验收标准

1. WHEN 新用户首次使用系统 THEN 系统 SHALL 为该用户分配5次免费识别配额
2. WHEN 用户完成一次食物识别 THEN 系统 SHALL 将该用户的剩余配额减少1次
3. WHEN 用户的剩余配额为0 THEN 系统 SHALL 阻止用户进行新的食物识别并显示配额用尽提示
4. WHEN 用户配额用尽 THEN 系统 SHALL 显示"观看广告获取试玩机会"的选项
5. WHEN 用户点击"观看广告"按钮 THEN 系统 SHALL 加载并播放广告内容
6. WHEN 用户完整观看广告 THEN 系统 SHALL 为该用户增加3次临时识别配额
7. WHEN 用户在观看广告过程中关闭或跳过 THEN 系统 SHALL 不增加配额并提示用户需完整观看
8. WHEN 管理员用户登录系统 THEN 系统 SHALL 识别管理员身份并提供无限识别配额
9. WHEN 系统显示用户界面 THEN 系统 SHALL 在显著位置显示当前剩余配额数量
10. WHEN 用户查看配额信息 THEN 系统 SHALL 区分显示基础配额和通过广告获得的试玩配额
11. WHEN 系统记录配额使用情况 THEN 系统 SHALL 将配额数据持久化存储到本地
12. WHEN 用户尝试清除浏览器数据 THEN 系统 SHALL 在清除前警告用户配额信息将被重置
13. WHEN 系统检测到配额数据异常 THEN 系统 SHALL 重置为默认的5次基础配额
14. WHEN 用户每日首次访问系统 THEN 系统 SHALL 检查是否需要重置每日试玩配额（可选功能）
15. WHEN 系统集成广告SDK THEN 系统 SHALL 确保广告加载不影响核心功能的正常使用

### 需求 16

**用户故事:** 作为用户，我希望了解配额使用情况和获取更多配额的方式，以便我能够持续使用系统功能

#### 验收标准

1. WHEN 用户访问主页面 THEN 系统 SHALL 在顶部导航栏显示配额图标和剩余次数
2. WHEN 用户点击配额图标 THEN 系统 SHALL 显示配额详情弹窗
3. WHEN 系统显示配额详情 THEN 系统 SHALL 包含基础配额、试玩配额、已使用次数和配额历史记录
4. WHEN 用户剩余配额少于2次 THEN 系统 SHALL 显示低配额警告提示
5. WHEN 用户配额为0 THEN 系统 SHALL 在上传按钮处显示"观看广告解锁"提示
6. WHEN 用户查看配额获取方式 THEN 系统 SHALL 说明观看广告可获得3次额外机会
7. WHEN 用户完成广告观看 THEN 系统 SHALL 显示成功提示和新增的配额数量
8. WHEN 系统显示广告加载状态 THEN 系统 SHALL 提供清晰的加载进度指示
9. WHEN 广告加载失败 THEN 系统 SHALL 显示友好的错误提示并提供重试选项
10. WHEN 用户是管理员 THEN 系统 SHALL 在配额显示处标注"无限制"或"管理员"标识

### 需求 17

**用户故事:** 作为开发者，我希望能够灵活配置广告提供商和配额规则，以便适应不同的运营策略

#### 验收标准

1. WHEN 系统初始化广告模块 THEN 系统 SHALL 从配置文件读取广告提供商信息
2. WHEN 系统配置广告参数 THEN 系统 SHALL 支持设置广告ID、广告类型和广告时长
3. WHEN 系统配置配额规则 THEN 系统 SHALL 支持设置基础配额数量和试玩配额数量
4. WHEN 系统配置管理员列表 THEN 系统 SHALL 支持通过用户ID或设备指纹识别管理员
5. WHEN 系统部署到生产环境 THEN 系统 SHALL 从环境变量读取广告配置而非硬编码
6. WHEN 系统记录配额使用日志 THEN 系统 SHALL 包含用户ID、操作类型、时间戳和配额变化
7. WHEN 系统统计配额使用数据 THEN 系统 SHALL 支持导出配额使用报告用于运营分析
8. WHEN 系统检测到广告SDK异常 THEN 系统 SHALL 降级到无广告模式并记录错误日志
9. WHEN 系统更新配额规则 THEN 系统 SHALL 确保现有用户的配额不受影响
10. WHEN 系统集成多个广告提供商 THEN 系统 SHALL 支持广告轮播和优先级配置
