# 非食物图片警告功能

## 🎯 功能说明

当本地 MobileNet 模型检测到非食物图片（置信度 ≥ 60%）时：
- ✅ **显示警告**：提示用户这可能不是食物
- ✅ **显示识别结果**：告知模型识别为什么（如：laptop, car）
- ✅ **显示置信度**：显示模型的置信度百分比
- ✅ **允许继续**：仍然调用云端 AI 分析（用户可能是对的）

## 🔍 检测逻辑

### 智能阈值判断

```typescript
if (maxFoodConfidence >= 0.25) {
  // 食物置信度 ≥ 0.25 → 放行
  isFood = true;
  reason = "检测到食物（置信度 XX%）";
  
} else if (maxNonFoodConfidence >= 0.6) {
  // 非食物置信度 ≥ 0.6 → 警告但继续
  isFood = false;
  shouldWarn = true;
  reason = "检测到非食物内容（置信度 XX%）";
  
} else {
  // 置信度不足 → 交给云端 AI
  isFood = true;
  reason = "置信度不足，将由云端 AI 进一步分析";
}
```

## 📊 三种场景

### 场景 1：明确是食物（置信度 ≥ 25%）
```
用户上传：披萨图片
本地检测：pizza (78.5%)
结果：✅ 直接放行，继续分析
```

### 场景 2：明确非食物（置信度 ≥ 60%）
```
用户上传：笔记本电脑图片
本地检测：laptop (85.2%)
结果：⚠️ 显示警告，但仍然继续分析
警告内容：
  ⚠️ 本地模型检测：这可能不是食物图片
  
  识别为：laptop
  置信度：85.2%
  
  将继续使用云端 AI 分析，但建议上传清晰的食物图片以获得更准确的结果。
```

### 场景 3：不确定（置信度 < 60%）
```
用户上传：模糊图片
本地检测：无法确定
结果：✅ 直接放行，交给云端 AI 判断
```

## 🎨 UI 展示

### 警告消息样式

```
┌─────────────────────────────────────────┐
│ ⚠️ 本地模型检测警告                      │
│                                         │
│ ⚠️ 本地模型检测：这可能不是食物图片      │
│                                         │
│ 识别为：laptop                          │
│ 置信度：85.2%                           │
│                                         │
│ 将继续使用云端 AI 分析，但建议上传清晰   │
│ 的食物图片以获得更准确的结果。           │
└─────────────────────────────────────────┘
```

### 颜色方案
- 背景：淡黄色 (#fff3cd)
- 边框：橙色 (#ffc107)
- 文字：深棕色 (#856404)

## 🔄 完整流程

```
用户上传图片
    ↓
[步骤 1] 图片压缩
    ↓
[步骤 2] 本地 MobileNet 检测
    ↓
    ├─ 食物置信度 ≥ 25% → ✅ 放行
    ├─ 非食物置信度 ≥ 60% → ⚠️ 警告 + 继续
    └─ 置信度不足 → ✅ 放行
    ↓
[步骤 3] 检查缓存
    ↓
[步骤 4] 云端 AI 分析
    ↓
显示结果
```

## 🧪 测试场景

### 测试 1：上传食物图片
**预期**：无警告，直接分析

```
上传：披萨图片
本地检测：pizza (78.5%)
警告：无
结果：正常显示营养信息
```

### 测试 2：上传明显非食物
**预期**：显示警告，但继续分析

```
上传：笔记本电脑图片
本地检测：laptop (85.2%)
警告：⚠️ 本地模型检测：这可能不是食物图片
      识别为：laptop
      置信度：85.2%
结果：云端 AI 返回 "NOT_FOOD" 错误
```

### 测试 3：上传模糊图片
**预期**：无警告，交给云端 AI

```
上传：模糊图片
本地检测：置信度不足
警告：无
结果：云端 AI 判断
```

### 测试 4：上传边缘案例
**预期**：可能有警告，但云端 AI 能识别

```
上传：创意食物（如：汉堡蛋糕）
本地检测：cake (55%) - 未达到 60%
警告：无
结果：云端 AI 正确识别为食物
```

## 📝 代码修改

### 1. useImageProcessor.ts
```typescript
// 如果检测到非食物且置信度高（≥60%），显示警告但允许继续
if (!detection.isFood && detection.shouldWarn) {
  const topPrediction = detection.predictions[0];
  const warningMessage = `⚠️ 本地模型检测：这可能不是食物图片\n\n识别为：${topPrediction?.className || '未知'}\n置信度：${(detection.confidence * 100).toFixed(1)}%\n\n将继续使用云端 AI 分析，但建议上传清晰的食物图片以获得更准确的结果。`;
  
  setState(prev => ({ 
    ...prev, 
    warning: warningMessage 
  }));
}
```

### 2. ImageUploader.tsx
```typescript
{state.warning && (
  <div className="warning-message">
    <div>
      <span className="warning-icon">⚠️</span>
      <strong>本地模型检测警告</strong>
    </div>
    <div style={{ whiteSpace: 'pre-line' }}>
      {state.warning}
    </div>
  </div>
)}
```

### 3. ImageUploader.css
```css
.warning-message {
  margin-top: 16px;
  padding: 16px;
  background-color: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 8px;
  color: #856404;
  line-height: 1.6;
}
```

## 🎯 设计理念

### 为什么警告后仍然继续？

1. **本地模型可能错误**
   - MobileNet 是通用模型，不是专门的食物识别模型
   - 可能将某些食物误判为非食物

2. **用户可能是对的**
   - 创意食物（如：汉堡蛋糕）
   - 特殊角度拍摄的食物
   - 本地模型未见过的食物

3. **云端 AI 更准确**
   - 豆包 Vision 模型专门训练过食物识别
   - 推理增强能力更强
   - 最终判断权交给云端

### 用户体验考虑

- ✅ **透明**：告知用户本地检测结果
- ✅ **友好**：不强制阻止，给用户选择权
- ✅ **建议**：提示上传更清晰的图片
- ✅ **继续**：不打断用户流程

## 📊 预期效果

### 误报率降低
- 本地模型误判 → 云端 AI 纠正
- 用户体验更好

### 提示更友好
- 不是硬性阻止
- 给出具体原因
- 允许用户继续

### 成本优化
- 明显非食物（≥60%）会有警告
- 但仍然调用 API（用户可能是对的）
- 云端 AI 最终判断

## 🔧 调整阈值

如果需要调整阈值，修改 `src/services/foodDetector.ts`：

```typescript
const FOOD_CONFIDENCE_THRESHOLD = 0.25;     // 食物阈值
const NON_FOOD_CONFIDENCE_THRESHOLD = 0.6;  // 非食物阈值（警告）
```

**建议值：**
- 食物阈值：0.20 - 0.30（太低会误报，太高会漏报）
- 非食物阈值：0.60 - 0.80（太低会频繁警告，太高会漏掉明显非食物）

---

**功能完成时间**：2025-11-24  
**状态**：✅ 已实现  
**测试**：上传非食物图片验证警告显示
